<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>BÃ¡o CÃ¡o Thá»‘ng KÃª Há»“ng Nhan (1950-2007)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/analytics.css') }}">
</head>

<body>
    <div class="container">
        <a href="/" class="nav-btn">â¬…ï¸ Quay láº¡i Trang Chá»§</a>
        <h1>ğŸ“Š BÃ¡o CÃ¡o PhÃ¢n TÃ­ch "Há»“ng Nhan" (1950 - 2007)</h1>
        
        {% if data.data_source == 'json_meta' %}
        <div class="card" style="background: #fff3cd; border: 1px solid #ffc107; color: #856404;">
            <strong>âš ï¸ LÆ°u Ã½:</strong> {{ data.note }}
            <br>Äá»ƒ cÃ³ dá»¯ liá»‡u chi tiáº¿t (SÆ°á»›ng/Khá»•), cáº§n cháº¡y full scan vÃ  táº¡o file CSV.
        </div>
        {% endif %}
        
        <!-- Gender Filter -->
        <div style="margin-bottom: 15px;">
            <label>Lá»c theo giá»›i tÃ­nh: </label>
            <select id="genderFilter" onchange="applyFilter()">
                <option value="all" {% if current_gender == 'all' %}selected{% endif %}>Táº¥t cáº£</option>
                <option value="nam" {% if current_gender == 'nam' %}selected{% endif %}>Nam</option>
                <option value="nu" {% if current_gender == 'nu' %}selected{% endif %}>Ná»¯</option>
            </select>
        </div>

        <div class="card bg-primary text-white"
            style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
            <div style="display: flex; justify-content: space-around; align-items: center; text-align: center;">
                <div>
                    <h3>Tá»•ng QuÃ©t (Total Scanned)</h3>
                    <div style="font-size: 2em; font-weight: bold;">{{ "{:,.0f}".format(data.total_scanned) }}</div>
                    <small>LÃ¡ sá»‘ (12 canh giá» x 365 ngÃ y x 58 nÄƒm)</small>
                </div>
                <div style="font-size: 2em;">ğŸ‘‰</div>
                <div>
                    <h3>TÃ¬m Tháº¥y (Beauty Found)</h3>
                    <div style="font-size: 2em; font-weight: bold;">{{ "{:,.0f}".format(data.count) }}</div>
                    <small>LÃ¡ sá»‘ Ä‘áº¡t chuáº©n Há»“ng Nhan ({{ "{:.1f}".format(data.count / data.total_scanned * 100)
                        }}%)</small>
                </div>
            </div>
        </div>

        {% if data.data_source != 'json_meta' %}
        <!-- Filter Panel -->
        <div class="card" style="background: #f8f9fa; border: 2px solid #dee2e6;">
            <h3 style="margin-top: 0;">ğŸ” Bá»™ Lá»c</h3>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: end;">
                <div>
                    <label><strong>Bá»™ Sao:</strong></label>
                    <select id="filterSet" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                        <option value="all">Táº¥t cáº£</option>
                        <option value="DAO_HONG">ÄÃ o Há»“ng Há»·</option>
                        <option value="VAN_TINH">VÄƒn XÆ°Æ¡ng/KhÃºc</option>
                        <option value="QUYEN_RU">Tham/LiÃªm</option>
                        <option value="PHUC_THIEN">Phá»§/TÆ°á»›ng/Ã‚m</option>
                    </select>
                </div>
                <div>
                    <label><strong>NÄƒm:</strong></label>
                    <select id="filterYear" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                        <option value="all">Táº¥t cáº£</option>
                        {% if data.line_labels %}
                        {% for year in data.line_labels %}
                        <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <div>
                    <button onclick="applyFilters()" style="padding: 8px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">âœ… Ãp dá»¥ng</button>
                    <button onclick="resetFilters()" style="padding: 8px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">ğŸ”„ Reset</button>
                </div>
            </div>
            <div id="filterInfo" style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 5px; color: #004085;">
                <strong>ğŸ“Š Äang xem:</strong> <span id="filterCount">{{ data.count }}</span> máº«u
            </div>
        </div>

        <!-- Legend Component -->
        <div class="card" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
            <h3 style="margin-top: 0; text-align: center;">ğŸ“Š LEGEND - 5 Cáº¤P Äá»˜ Há»’NG NHAN</h3>
            <div id="legendContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
                <!-- Legend items will be populated by JavaScript -->
            </div>
        </div>

        <div class="row">
            <div class="col card">
                <h2>1. PhÃ¢n Bá»‘ 5 Cáº¥p Äá»™ (ToÃ n bá»™)</h2>
                <canvas id="pieChart"></canvas>
            </div>
            <div class="col card">
                <h2>2. TÆ°Æ¡ng Quan Theo Bá»™ Sao</h2>
                <canvas id="barChart"></canvas>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <h2>3. Tá»· Lá»‡ PhÃ¢n Bá»• Há»“ng Nhan Theo NÄƒm (%)</h2>
            <p>Trong má»™t nÄƒm, cÃ³ bao nhiÃªu % lÃ¡ sá»‘ sinh ra lÃ  "NgÆ°á»i Äáº¹p"?</p>
            <canvas id="beautyRateChart" height="80"></canvas>
        </div>

        {% if data.data_source != 'json_meta' %}
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2>4. Xu HÆ°á»›ng SÆ°á»›ng vs Khá»• (Drill Down)</h2>
                    <p id="chartTitle">Dá»¯ liá»‡u theo NÄƒm (Click vÃ o Ä‘iá»ƒm Ä‘á»ƒ xem chi tiáº¿t)</p>
                </div>
                <button id="resetZoomBtn" class="btn btn-sm" onclick="resetDrillDown()"
                    style="display: none; background: #607d8b; color: white;">ğŸ”„ Xem Táº¥t Cáº£ NÄƒm</button>
            </div>
            <canvas id="lineChart" height="100"></canvas>
        </div>
        {% endif %}
        {% if data.line_beauty_count %}
        <div class="card" style="background: #e3f2fd;">
            <h2>4. Sá»‘ LÆ°á»£ng Há»“ng Nhan Theo NÄƒm</h2>
            <p>Sá»‘ lÃ¡ sá»‘ "Há»“ng Nhan" tÃ¬m tháº¥y má»—i nÄƒm</p>
            <canvas id="countChart" height="100"></canvas>
        </div>
        {% endif %}
    </div>

    <!-- Jinja2 server-side data bridge -->
    <script>
        const currentGender = "{{ current_gender }}";
        const dataSource = "{{ data.data_source | default('csv', true) }}";
        const serverFateLabels = {{ data.fate_labels | tojson }};
        const serverPieData = {{ data.pie_data | tojson }};
        const serverBeautySets = {{ data.beauty_sets | tojson }};
        const serverBarDatasets = {{ data.bar_datasets | tojson }};
        const serverLineLabels = {{ data.line_labels | tojson }};
        const serverLineLucky = {{ data.line_lucky | tojson }};
        const serverLineTragic = {{ data.line_tragic | tojson }};
        const serverLineBeautyRate = {{ data.line_beauty_rate | tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/analytics.js') }}"></script>
    <script>
        // Initialize charts based on data source
        {% if data.data_source != 'json_meta' %}
        initCsvCharts();
        {% endif %}

        initBeautyRateChart();

        {% if data.line_beauty_count %}
        initCountChart({{ data.line_beauty_count | tojson }});
        {% endif %}
    </script>
</body>

</html>