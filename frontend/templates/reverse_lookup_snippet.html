<!-- Reverse Lookup Modal -->
<div id="reverseLookupModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <span class="close">&times;</span>
        <h2>Tra Cứu Ngược (Tìm Ngày Sinh từ Sao)</h2>

        <div class="reverse-container" style="display: flex; gap: 20px;">
            <!-- Left: Star Selection -->
            <div style="flex: 1;">
                <h3>1. Chọn Sao và Cung</h3>
                <div class="form-group">
                    <label>Sao muốn tìm:</label>
                    <select id="revStarSelect" class="form-control">
                        <option value="Tử Vi">Tử Vi</option>
                        <option value="Lộc Tồn">Lộc Tồn</option>
                        <option value="Thái Tuế">Thái Tuế</option>
                        <option value="Thiên Mã">Thiên Mã</option>
                        <option value="Tả Phụ">Tả Phụ</option>
                        <option value="Hữu Bật">Hữu Bật</option>
                        <option value="Văn Xương">Văn Xương</option>
                        <option value="Văn Khúc">Văn Khúc</option>
                        <option value="Kinh Dương">Kinh Dương</option>
                        <option value="Đà La">Đà La</option>
                        <option value="Thiên Khôi">Thiên Khôi</option>
                        <option value="Thiên Việt">Thiên Việt</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Đặt tại Cung:</label>
                    <select id="revPalaceSelect" class="form-control">
                        <option value="0">Tý</option>
                        <option value="1">Sửu</option>
                        <option value="2">Dần</option>
                        <option value="3">Mão</option>
                        <option value="4">Thìn</option>
                        <option value="5">Tỵ</option>
                        <option value="6">Ngọ</option>
                        <option value="7">Mùi</option>
                        <option value="8">Thân</option>
                        <option value="9">Dậu</option>
                        <option value="10">Tuất</option>
                        <option value="11">Hợi</option>
                    </select>
                </div>
                <button onclick="addConstraint()" class="btn-primary" style="width:100%">Thêm Điều Kiện</button>

                <h3 style="margin-top: 20px;">2. Điều kiện đã chọn</h3>
                <ul id="constraintList" style="min-height: 100px; border: 1px solid #ddd; padding: 10px;"></ul>

                <button onclick="searchDates()" class="btn-primary"
                    style="width:100%; margin-top: 10px; background-color: #28a745;">Tìm Ngày Sinh</button>
            </div>

            <!-- Right: Results -->
            <div style="flex: 1;">
                <h3>3. Kết quả Tìm kiếm</h3>
                <div id="searchResults" style="height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                    <div style="color: #666; text-align: center; padding-top: 50px;">Kết quả sẽ hiện ở đây...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let constraints = {};

    function addConstraint() {
        const star = document.getElementById('revStarSelect').value;
        const palaceVal = document.getElementById('revPalaceSelect').value;
        const palaceName = document.getElementById('revPalaceSelect').options[document.getElementById('revPalaceSelect').selectedIndex].text;

        constraints[star] = parseInt(palaceVal);
        renderConstraints();
    }

    function removeConstraint(star) {
        delete constraints[star];
        renderConstraints();
    }

    function renderConstraints() {
        const list = document.getElementById('constraintList');
        list.innerHTML = '';

        const palaceNames = ["Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi", "Thân", "Dậu", "Tuất", "Hợi"];

        for (const [star, palace] of Object.entries(constraints)) {
            const li = document.createElement('li');
            li.style.display = 'flex';
            li.style.justifyContent = 'space-between';
            li.style.marginBottom = '5px';
            li.innerHTML = `
                <span><b>${star}</b> tại <b>${palaceNames[palace]}</b></span>
                <span style="color:red; cursor:pointer;" onclick="removeConstraint('${star}')">×</span>
            `;
            list.appendChild(li);
        }
    }

    async function searchDates() {
        if (Object.keys(constraints).length === 0) {
            alert("Vui lòng thêm ít nhất 1 điều kiện sao!");
            return;
        }

        const resDiv = document.getElementById('searchResults');
        resDiv.innerHTML = '<div style="text-align:center">Đang tìm kiếm...</div>';

        try {
            const response = await fetch('/api/reverse_lookup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stars: constraints })
            });

            const data = await response.json();

            if (data.error) {
                resDiv.innerHTML = `<div style="color:red">Lỗi: ${data.error}</div>`;
                return;
            }

            if (data.results.length === 0) {
                resDiv.innerHTML = '<div style="text-align:center">Không tìm thấy ngày sinh nào phù hợp!</div>';
                return;
            }

            let html = `<div style="margin-bottom:10px;">Tìm thấy <b>${data.count}</b> kết quả:</div>`;
            html += '<ul style="padding-left: 20px;">';
            data.results.forEach(item => {
                html += `<li style="margin-bottom: 5px;">${item.display}</li>`;
            });
            html += '</ul>';
            resDiv.innerHTML = html;

        } catch (e) {
            resDiv.innerHTML = `<div style="color:red">Lỗi kết nối: ${e}</div>`;
        }
    }

    // Quick helper to open modal
    function openReverseLookup() {
        document.getElementById('reverseLookupModal').style.display = 'block';
    }

    // Close modal logic
    document.querySelector('.close').onclick = function () {
        document.getElementById('reverseLookupModal').style.display = 'none';
    }
    window.onclick = function (event) {
        if (event.target == document.getElementById('reverseLookupModal')) {
            document.getElementById('reverseLookupModal').style.display = 'none';
        }
    }
</script>